%
% formerly mcodpy_01.m (combination of mcod_01 and mcod_02 for codas python
% netcdf output files)
%
% /local/users/pstar/jc159/mcruise/data/vmadcp/jc159_os150/adcp_pyproc/jc159_enrproc/os150nb/contour
% 
% allbins_amp.mat
% allbins_bt.mat
% allbins_depth.mat
% allbins_e.mat
% allbins_other.mat
% allbins_pf.mat
% allbins_pg.mat
% allbins_raw_amp.mat
% allbins_resid_stats.mat
% allbins_sw.mat
% allbins_tseries_diffstats.mat
% allbins_tseries_stats.mat
% allbins_u.mat
% allbins_v.mat
% allbins_w.mat
% 
% >> nc_getall('os150nb.nc')
% Warning: NC_GETALL is deprecated and may be removed in a future version of SNCTOOLS. 
% > In nc_getall at 18
% 
% ans = 
% 
%      trajectory: [1x1 struct]
%            time: [1x1 struct]
%             lon: [1x1 struct]
%             lat: [1x1 struct]
%           depth: [1x1 struct]
%               u: [1x1 struct]
%               v: [1x1 struct]
%             amp: [1x1 struct]
%              pg: [1x1 struct]
%           pflag: [1x1 struct]
%         heading: [1x1 struct]
%         tr_temp: [1x1 struct]
%       num_pings: [1x1 struct]
%           uship: [1x1 struct]
%           vship: [1x1 struct]
%     global_atts: [1x1 struct]

% script mcodpy_01 to replace mcod_01 an mcod_02 using outout from 
% python version of codas for vmadcp
%
% first draft bak jc159 1 April 2018
% based on previous mcod_01
%
% Unlike previous versions, runs on a single appended file for a whole
% cruise, input file example is os150nb.nc
% to run on os75 nb without prompts type
%
% os = 75; nbb = 1; mcodpy_01


m_common
m_margslocal
m_varargs

scriptname = 'mcodpy_01';
mcruise = MEXEC_G.MSCRIPT_CRUISE_STRING;


if exist('os','var')
    m = ['Running script ' scriptname ' for OS ' sprintf('%d',os)];
    fprintf(MEXEC_A.Mfidterm,'%s\n',m)
else
    os = input('Enter OS type: 75 or 150 ');
end
inst=['os' sprintf('%d',os)];

if ~exist('nbb'); 
    nbb = input('Enter narrowband (1) or broadband (2) '); 
end
if nbb==1; 
    nbbstr='nb';
else 
    nbbstr='bb'; 
end


root_vmadcp = mgetdir('M_VMADCP');
str1 = [mcruise '_' inst];
str2 = [mcruise '_enrproc']; % may have to vary if not processed from enr
str3 = [inst nbbstr];

datadir = [root_vmadcp '/' str1 '/adcp_pyproc/' str2 '/' str3 '/contour'];
if exist(datadir) ~= 7
    fprintf(2,'%s %s %s\n','Data directory',datadir,'not found in mcodpy_01');
    return
else
    fprintf(1,'%s %s %s\n','Data directory',datadir,'found');    
end

clear os; % so it doesn't persist

fnin = [datadir '/' str3 '.nc'];
dataname = [inst '_' mcruise '_01'];
otfile = [root_vmadcp '/' mcruise '_' inst '/mexec/' dataname '.nc'];

clear allin

allin.decday = nc_varget(fnin,'time');
tu = nc_attget(fnin,'time','units');
allin.lon = nc_varget(fnin,'lon'); 
allin.lat = nc_varget(fnin,'lat'); 
allin.depth = nc_varget(fnin,'depth'); 
allin.uabs = 100*nc_varget(fnin,'u'); % we have used cm/s in the past; codas netcdf uses m/s
allin.vabs = 100*nc_varget(fnin,'v'); 
allin.uship = nc_varget(fnin,'uship'); 
allin.vship = nc_varget(fnin,'vship'); 
kf = strfind(tu,'since');
torgstr = tu(kf+5:end);
cotorg = datenum(torgstr);
torgstr = datestr(cotorg,'yyyy mm dd HH MM SS');
allin.dnum = allin.decday + cotorg; % input time is decimal days past an origin

% expand the 1-D vars to 2-D

clear allot

ndeps = size(allin.depth,2);
allot = allin;
allot.time = repmat(allin.time,1,ndeps);
allot.lat = repmat(allin.lat,1,ndeps);
allot.lon = repmat(allin.lon,1,ndeps);
allot.decday = repmat(allin.decday,1,ndeps);
allot.uship = repmat(allin.uship,1,ndeps);
allot.vship = repmat(allin.vship,1,ndeps);
allot.speed = sqrt(allot.uabs.*allot.uabs + allot.vabs.*allot.vabs);
allot.shipspd = sqrt(allot.uship.*allot.uship + allot.vship.*allot.vship);

% have to move the variables from structure to vars before we can save

varnames = fieldnames(allot);
for kl = 1:length(varnames)
    kv = varnames{kl};
    cmd = ['clear ' kv]; eval(cmd);
    cmd = [kv ' = double(allot.' kv ');']; eval(cmd);
end

%This fits with vmadpc_proc

timestring = torgstr;

MEXEC_A.MARGS_IN = {
otfile
'time'
'lon'
'lat'
'depth'
'uabs'
'vabs'
'uship'
'vship'
'decday'
'speed'
'shipspd'
' '
' '
'1'
dataname
'/'
'2'
MEXEC_G.PLATFORM_TYPE
MEXEC_G.PLATFORM_IDENTIFIER
MEXEC_G.PLATFORM_NUMBER
'/'
'4'
timestring
'/'
'8'
'time'
'/'
'seconds'
'lon'
'/'
'degrees'
'lat'
'/'
'degrees'
'depth'
'/'
'metres'
'uabs'
'/'
'cm/s'
'vabs'
'/'
'cm/s'
'uship'
'/'
'm/s'
'vship'
'/'
'm/s'
'decday'
'/'
'days'
'speed'
'/'
'cm/s'
'shipspd'
'/'
'm/s'
'-1'
'-1'
};
msave

